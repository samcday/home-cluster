---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mastodon
  namespace: mastodon
spec:
  chart:
    spec:
      chart: .
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: mastodon-chart
        namespace: mastodon
  interval: 1h
  # https://github.com/mastodon/chart/blob/main/values.yaml
  values:
    affinity: &cloudaff
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            preference:
              matchExpressions:
                - key: samcday.com/cloud
                  operator: Exists
    # https://github.com/bitnami/charts/blob/main/bitnami/elasticsearch/values.yaml
    elasticsearch:
      enabled: false
      coordinating:
        tolerations: &cloudtol
          - key: samcday.com/cloud
            effect: NoExecute
      data:
        affinity: *cloudaff
        tolerations: *cloudtol
      global:
        storageClass: syncthing
      ingest:
        affinity: *cloudaff
        tolerations: *cloudtol
      master:
        affinity: *cloudaff
        tolerations: *cloudtol
      metrics:
        affinity: *cloudaff
        tolerations: *cloudtol
    ingress:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
      hosts:
        - host: samcday.social
          paths:
            - path: '/'
      ingressClassName: nginx
      tls:
        - secretName: tls
          hosts: [samcday.social]
    mastodon:
      createAdmin:
        enabled: true
        username: me
        email: me@samcday.com
      local_domain: samcday.social
      persistence:
        assets:
          accessMode: ReadWriteMany
          storageClassName: seaweedfs-storage
        system:
          accessMode: ReadWriteMany
          storageClassName: seaweedfs-storage
      secrets:
        existingSecret: secrets
      singleUserMode: true
      smtp:
        auth_method: plain
        ca_file: /etc/ssl/certs/ca-certificates.crt
        delivery_method: smtp
        domain: mastodon.samcday.com
        enable_starttls: auto
        from_address: postmaster@mastodon.samcday.com
        port: 587
        server: smtp.mailgun.org
        tls: false
        existingSecret: mailgun
    postgresql:
      enabled: false
      postgresqlHostname: public-db.postgres.svc.cluster.local.
      postgresqlPort: 5432
      auth:
        database: mastodon
        existingSecret: mastodon-owner-user.public-db.credentials.postgresql.acid.zalan.do
        username: mastodon_owner_user
    # https://github.com/bitnami/charts/blob/main/bitnami/redis/values.yaml
    redis:
      architecture: standalone
      global:
        storageClass: syncthing
      master:
        tolerations: *cloudtol
      replica:
        replicaCount: 0
        tolerations: *cloudtol
    tolerations: *cloudtol

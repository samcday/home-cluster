---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mastodon
  namespace: mastodon
spec:
  chart:
    spec:
      chart: .
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: mastodon-chart
        namespace: mastodon
  interval: 1h
  # https://github.com/mastodon/chart/blob/main/values.yaml
  values:
    # https://github.com/bitnami/charts/blob/main/bitnami/elasticsearch/values.yaml
    elasticsearch:
      clusterDomain: home-cluster.local
    image:
      repository: ghcr.io/mastodon/mastodon
      tag: "v4.2.10"
    ingress:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
      hosts:
        - host: mastodon.samcday.com
          paths:
            - path: '/'
      ingressClassName: public-nginx
      tls:
        - secretName: tls
          hosts: [mastodon.samcday.com]
    mastodon:
      createAdmin:
        enabled: true
        username: me
        email: me@samcday.com
      local_domain: samcday.com
      web_domain: mastodon.samcday.com
      persistence:
        assets:
          storageClassName: ceph-block
        system:
          storageClassName: ceph-block
      secrets:
        existingSecret: secrets
      singleUserMode: true
      smtp:
        auth_method: plain
        ca_file: /etc/ssl/certs/ca-certificates.crt
        delivery_method: smtp
        domain: mastodon.samcday.com
        enable_starttls: auto
        from_address: postmaster@mastodon.samcday.com
        port: 587
        server: smtp.mailgun.org
        tls: false
        existingSecret: mailgun
      # TODO: figure out why this is necessary
      web: &aff
        affinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/part-of
                    operator: In
                    values:
                      - rails
              topologyKey: kubernetes.io/hostname
      workers: *aff
    postgresql:
      enabled: false
      postgresqlHostname: db-rw
      postgresqlPort: 5432
      auth:
        database: mastodon
        existingSecret: db-app
        username: mastodon
    # https://github.com/bitnami/charts/blob/main/bitnami/redis/values.yaml
    redis:
      architecture: standalone
      replica:
        replicaCount: 0
    s3:
      enabled: true
      existingSecret: bucket
      endpoint: rook-ceph-rgw-ceph-objectstore.rook-ceph.svc:80
  valuesFrom:
    - kind: ConfigMap
      name: bucket
      valuesKey: BUCKET_NAME
      targetPath: s3.bucket

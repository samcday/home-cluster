---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: etcd
  namespace: cloud-cluster
spec:
  chart:
    spec:
      chart: etcd
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      version: 10.2.7
  interval: 1h
  kubeConfig:
    secretRef:
      name: admin-kubeconfig
  storageNamespace: etcd
  targetNamespace: etcd
  values:
    # https://github.com/bitnami/charts/blob/main/bitnami/etcd/values.yaml
    auth:
      rbac:
        create: true
    autoCompactionMode: periodic
    autoCompactionRetention: 30m
    replicaCount: 3
  valuesFrom:
    - kind: Secret
      name: etcd-root-password
      valuesKey: password
      targetPath: auth.rbac.rootPassword

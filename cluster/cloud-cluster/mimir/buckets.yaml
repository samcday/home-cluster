apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: mimir-ruler-bucket
  namespace: cloud-cluster
spec:
  approvePlan: auto
  interval: 1h
  path: ./tofu-modules/bucket
  runnerPodTemplate:
    spec:
      env:
        - name: KUBE_CONFIG_PATH
          value: /kubeconfig
      envFrom:
        - secretRef:
            name: b2-env
      volumeMounts:
        - name: cert
          mountPath: /cert
        - name: kubeconfig
          mountPath: /kubeconfig
          subPath: kubeconfig
      volumes:
        - name: cert
          secret:
            secretName: admin
        - name: kubeconfig
          configMap:
            name: kubeconfig
  sourceRef:
    kind: GitRepository
    name: home-cluster-https
    namespace: flux-system
  storeReadablePlan: human
  vars:
    - name: namespace
      value: mimir
    - name: name
      value: ruler
---
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: mimir-blocks-bucket
  namespace: cloud-cluster
spec:
  approvePlan: auto
  interval: 1h
  path: ./tofu-modules/bucket
  runnerPodTemplate:
    spec:
      envFrom:
        - secretRef:
            name: b2-env
  sourceRef:
    kind: GitRepository
    name: home-cluster-https
    namespace: flux-system
  storeReadablePlan: human
  vars:
    - name: namespace
      value: mimir
    - name: name
      value: blocks
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tf-runner-mimir-buckets
  namespace: cloud-cluster
rules:
  - apiGroups: []
    resourceNames: [blocks-bucket, ruler-bucket]
    resources: [secrets]
    verbs: ['*']
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tf-runner-mimir-buckets
  namespace: cloud-cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tf-runner-mimir-buckets
subjects:
  - kind: ServiceAccount
    name: tf-runner

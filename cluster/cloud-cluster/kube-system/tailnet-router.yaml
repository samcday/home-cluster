apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-system-tailnet-router
  namespace: cloud-cluster
spec:
  chart:
    spec:
      chart: charts/resources
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: home-cluster
        namespace: flux-system
  driftDetection:
    mode: enabled
  interval: 1h
  kubeConfig:
    secretRef:
      name: admin-kubeconfig
  storageNamespace: kube-system
  targetNamespace: kube-system
  values:
    sts:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: tailnet-router
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: tailnet-router
        template:
          metadata:
            labels:
              app: tailnet-router
          spec:
            serviceAccountName: tailnet-router
            containers:
              - name: tailscale
                image: ghcr.io/tailscale/tailscale:v1.70.0
                env:
                  - name: TS_EXTRA_ARGS
                    value: --login-server=https://headscale.taild2b250.ts.net
                  - name: TS_KUBE_SECRET
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: metadata.name
                  - name: TS_USERSPACE
                    value: "true"
                  - name: TS_DEBUG_FIREWALL_MODE
                    value: auto
                  - name: TS_AUTHKEY
                    valueFrom:
                      secretKeyRef:
                        name: tailnet-router-auth
                        key: TS_AUTHKEY
                  - name: TS_ROUTES
                    value: 172.27.0.0/16
                # livenessProbe:
                #   exec:
                #     command:
                #     - tailscale
                #     - ping
                #     - home-cluster-router
                #   initialDelaySeconds: 1
                #   periodSeconds: 5
                securityContext:
                  capabilities:
                    add: [NET_ADMIN]
    role:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        name: tailnet-router
      rules:
      - apiGroups: [""]
        resources: [secrets]
        verbs: [create]
      - apiGroups: [""]
        resourceNames: [tailnet-router-0, tailnet-router-1]
        resources: [secrets]
        verbs: [get, update, patch]
    rb:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: tailnet-router
      subjects:
      - kind: ServiceAccount
        name: tailnet-router
      roleRef:
        kind: Role
        name: tailnet-router
        apiGroup: rbac.authorization.k8s.io
    sa:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: tailnet-router

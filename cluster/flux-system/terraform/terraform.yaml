apiVersion: infra.contrib.fluxcd.io/v1alpha1
kind: Terraform
metadata:
  name: terraform
  namespace: flux-system
spec:
  interval: 1h
  approvePlan: auto
  path: home-cluster/flux-system/terraform
  runnerPodTemplate:
    spec:
      envFrom:
        - secretRef:
            name: tf-env
  sourceRef:
    kind: GitRepository
    name: hominions
    namespace: flux-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: flux-system-tf-runner
rules:
  - apiGroups: [apiextensions.k8s.io]
    resources: [customresourcedefinitions]
    verbs: [list]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: flux-system-tf-runner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flux-system-tf-runner
subjects:
  - kind: ServiceAccount
    name: tf-runner
    namespace: flux-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tf-runner-notifs
  namespace: flux-system
rules:
  - apiGroups: [notification.toolkit.fluxcd.io]
    resources: [receivers]
    verbs: [get]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tf-runner-notifs
  namespace: flux-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tf-runner-notifs
subjects:
  - kind: ServiceAccount
    name: tf-runner

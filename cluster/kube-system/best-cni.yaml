# Very Good CNI, best engineering. Many GitHub stars.
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: best-cni
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: best-cni
  template:
    metadata:
      labels:
        app: best-cni
    spec:
      containers:
        - name: best-cni
          image: alpine:3
          args:
            - chroot
            - /host
            - bash
            - -l
            - -c
            - |-
              set -uexo pipefail
              export KUBECONFIG=/etc/kubernetes/kubelet.conf
              while true; do
                pod_cidr=$(kubectl get node ${NODE_NAME} -o 'jsonpath={.spec.podCIDR}')
                cni_dir=$(cat /etc/containerd/config.toml | grep -A5 'plugins."io.containerd.grpc.v1.cri".cni' | grep conf_dir | sed -e 's/.*conf_dir = "\(.*\)"/\1/')
                if [[ ! -d $cni_dir ]]; then
                  mkdir -p $cni_dir
                fi
                cat > /tmp/best-cni.conflist <<HERE
              {
                "name": "k8s-pod-network",
                "cniVersion": "0.3.1",
                "plugins": [
                  {
                    "type": "ptp",
                    "mtu": 1460,
                    "ipam": {
                      "type": "host-local",
                      "subnet": "${pod_cidr}",
                      "routes": [
                        {
                          "dst": "0.0.0.0/0"
                        }
                      ]
                    }
                  },
                  {
                    "type": "portmap",
                    "capabilities": {
                      "portMappings": true
                    }
                  }
                ]
              }
              HERE
                if ! diff /tmp/best-cni.conflist $cni_dir/best-cni.conflist; then
                  mv /tmp/best-cni.conflist $cni_dir/best-cni.conflist
                fi
                sleep 10
              done
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          securityContext:
            privileged: true
          volumeMounts:
            - name: host
              mountPath: /host
      hostNetwork: true
      terminationGracePeriodSeconds: 1
      tolerations:
        - operator: Exists
      volumes:
        - name: host
          hostPath:
            path: /

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-tailscale
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: node-tailscale
  template:
    metadata:
      labels:
        app.kubernetes.io/name: node-tailscale
    spec:
      containers:
        - name: node-tailscale
          image: ghcr.io/tailscale/tailscale:v1.68.1
          env:
            - name: TS_EXTRA_ARGS
              value: --login-server=https://headscale.taild2b250.ts.net --accept-routes
            - name: TS_USERSPACE
              value: "false"
            - name: TS_DEBUG_FIREWALL_MODE
              value: auto
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  name: node-tailscale
                  key: authkey
            - name: TS_STATE_DIR
              value: /state
            - name: TS_KUBE_SECRET
              value: ""
          securityContext:
            capabilities:
              add: [NET_ADMIN]
          volumeMounts:
            - name: tailscaled-state
              mountPath: /state
      # hostNetwork: true
      nodeSelector:
        kubernetes.io/hostname: m715q-1
      tolerations:
        - key: samcday.com/shrimpy-boi
          operator: Exists
      volumes:
        - name: tailscaled-state
          hostPath:
            path: /var/lib/node-tailscaled
            type: DirectoryOrCreate

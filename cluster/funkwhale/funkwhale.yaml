apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: funkwhale
  namespace: funkwhale
spec:
  chart:
    spec:
      chart: funkwhale
      sourceRef:
        kind: HelmRepository
        name: ananace-charts
        namespace: flux-system
      version: 2.0.3
  interval: 1h
  values:
    # https://github.com/ananace/personal-charts/blob/master/charts/funkwhale/values.yaml
    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
      className: nginx
      host: funkwhale.samcday.com
      protocol: https
      tls:
        - secretName: certificate
          hosts: [funkwhale.samcday.com]
    persistence:
      enabled: true
      existingClaim: data
    postgresql:
      enabled: false
      host: db-20231026-rw
    redis:
      enabled: false
      host: redis-master
    # s3:
    #   enabled: true
    #   url: http://rook-ceph-rgw-ceph-objectstore.rook-ceph.svc
  valuesFrom:
    - kind: Secret
      name: db-20231026-app
      valuesKey: username
      targetPath: postgresql.auth.username
    - kind: Secret
      name: db-20231026-app
      valuesKey: password
      targetPath: postgresql.auth.password
    - kind: Secret
      name: db-20231026-app
      valuesKey: dbname
      targetPath: postgresql.auth.database
    - kind: Secret
      name: redis
      valuesKey: redis-password
      targetPath: redis.auth.password
    - kind: Secret
      name: django-secret
      valuesKey: secret
      targetPath: djangoSecret
    # - kind: Secret
    #   name: media
    #   valuesKey: AWS_ACCESS_KEY_ID
    #   targetPath: s3.accessKey
    # - kind: Secret
    #   name: media
    #   valuesKey: AWS_SECRET_ACCESS_KEY
    #   targetPath: s3.secretKey
    # - kind: ConfigMap
    #   name: media
    #   valuesKey: BUCKET_NAME
    #   targetPath: s3.bucket

  #   # https://codeberg.org/forgejo-contrib/forgejo-helm/src/branch/main/values.yaml
  #   clusterDomain: home-cluster.local
  #   gitea:
  #     admin:
  #       email: me@samcday.com
  #       username: me
  #     config:
  #       actions:
  #         ENABLED: true
  #       database:
  #         DB_TYPE: postgres
  #         HOST: db-20230922-rw:5432
  #         NAME: forgejo
  #         SSL_MODE: require
  #       git.timeout:
  #         MIGRATE: 3600
  #         MIRROR: 3600
  #       metrics:
  #         ENABLED: true
  #         ENABLED_ISSUE_BY_LABEL: true
  #         ENABLED_ISSUE_BY_REPOSITORY: true
  #       server:
  #         DISABLE_SSH: true
  #       service:
  #         DISABLE_REGISTRATION: true
  #       session:
  #         PROVIDER: db
  #       storage:
  #         STORAGE_TYPE: minio
  #         MINIO_ENDPOINT: rook-ceph-rgw-ceph-objectstore.rook-ceph.svc:80
  #   persistence:
  #     storageClass: ceph-block
  #   postgresql:
  #     enabled: false
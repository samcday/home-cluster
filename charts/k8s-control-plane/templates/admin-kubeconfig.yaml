apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: admin
spec:
  commonName: kubernetes-admin
  duration: 336h # 2 weeks
  issuerRef:
    name: ca
    kind: Issuer
  secretName: admin
  subject:
    organizations: [system:masters]
  usages: [client auth]
---
{{- $cert := (lookup "v1" "Secret" $.Release.Namespace "admin") -}}
apiVersion: v1
kind: Secret
metadata:
  name: admin-kubeconfig
  annotations:
    helm.sh/hook: post-install,post-upgrade
stringData:
    kubeconfig: |
        apiVersion: v1
        clusters:
        - cluster:
            certificate-authority-data: {{ get ($cert.data) "ca.crt" }}
            server: https://{{ $.Values.externalHostname }}:6443
          name: {{ $.Values.clusterName }}
        contexts:
        - context:
            cluster: {{ $.Values.clusterName }}
            user: {{ $.Values.clusterName }}-admin
          name: {{ $.Values.clusterName }}-admin@{{ $.Values.clusterName }}
        current-context: {{ $.Values.clusterName }}-admin@{{ $.Values.clusterName }}
        kind: Config
        preferences: {}
        users:
        - name: {{ $.Values.clusterName }}-admin
          user:
            client-certificate-data: {{ get ($cert.data) "tls.crt" }}
            client-key-data: {{ get ($cert.data) "tls.key" }}
